<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>申论格子编辑工具（iPad可用·聚焦优化版）</title>
    <style>
        .control-panel {
            margin: 20px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        button, input {
            padding: 10px 16px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ccc;
            touch-action: manipulation;
        }
        button {
            background-color: #f5f5f5;
            cursor: pointer;
        }
        button:active {
            background-color: #e0e0e0;
        }
        .count-info {
            color: #333;
            font-weight: bold;
            font-size: 16px;
            margin-top: 8px;
        }
        .count-info.red {
            color: #e53935;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(25, 28px);
            gap: 0;
            border-top: 1px solid #ccc;
            border-left: 1px solid #ccc;
            margin: 0 15px;
            overflow-x: auto;
            padding-bottom: 15px;
        }
        .grid-cell {
            width: 28px;
            height: 28px;
            border-right: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            font-size: 16px;
            line-height: 28px;
            text-align: center;
            outline: none;
            cursor: text;
            touch-action: manipulation;
        }
        .grid-cell.indent {
            background-color: #f5f5f5;
            pointer-events: none;
        }
        .grid-cell:focus {
            border: 2px solid #2196f3;
            margin: -1px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div class="control-panel">
        <label style="font-size: 16px;">格子行数：</label>
        <input type="number" id="rowInput" value="20" min="5" max="50" style="width: 80px;">
        <button onclick="generateGrid()">生成格子</button>
        <button onclick="clearGrid()">清空内容</button>
        <button onclick="copyAllContent()">复制内容</button>
        <button onclick="exportAsImage()">导出图片</button>
        <div class="count-info" id="countInfo">已用格子：0 / <span id="totalGrid">500</span></div>
    </div>

    <div class="grid-container" id="gridContainer"></div>

    <script>
        const COL_NUM = 25;
        let currentRow = 20;
        let gridCells = [];

        function generateGrid() {
            const rowInput = document.getElementById('rowInput');
            const rowNum = parseInt(rowInput.value);
            
            if (isNaN(rowNum) || rowNum < 5 || rowNum > 50) {
                alert('请输入 5-50 之间的行数！');
                rowInput.value = currentRow;
                return;
            }

            currentRow = rowNum;
            const totalGrid = COL_NUM * currentRow;
            document.getElementById('totalGrid').textContent = totalGrid;

            const gridContainer = document.getElementById('gridContainer');
            gridContainer.innerHTML = '';
            gridCells = [];

            for (let row = 0; row < currentRow; row++) {
                for (let col = 0; col < COL_NUM; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    
                    if (row >= 1 && col < 2) {
                        cell.classList.add('indent');
                    }

                    cell.contentEditable = row >= 1 && col < 2? false : true;

                    cell.addEventListener('input', function() {
                        // 退格键处理
                        const isBackspace = this.textContent === '' && event.inputType === 'deleteContentBackward';
                        if (isBackspace) {
                            const currentIndex = gridCells.indexOf(this);
                            if (currentIndex > 0) {
                                this.textContent = '';
                                const prevCell = gridCells[currentIndex - 1];
                                prevCell.focus();
                                const range = document.createRange();
                                const sel = window.getSelection();
                                range.selectNodeContents(prevCell);
                                range.collapse(false);
                                sel.removeAllRanges();
                                sel.addRange(range);
                            }
                            updateCount();
                            return;
                        }

                        // 核心修复：多字符输入时的聚焦逻辑
                        if (this.textContent.length > 1) {
                            const allChars = this.textContent; // 取所有输入字符（含第一个）
                            this.textContent = allChars[0]; // 当前格子只留第一个字符
                            const extraChars = allChars.slice(1); // 多余字符

                            let currentIndex = gridCells.indexOf(this);
                            let lastFilledIndex = currentIndex; // 记录最后一个填字符的格子索引

                            // 填充多余字符到后续格子
                            for (let i = 0; i < extraChars.length; i++) {
                                currentIndex++;
                                if (currentIndex >= gridCells.length) break; // 超出总格子数则停止
                                gridCells[currentIndex].textContent = extraChars[i];
                                lastFilledIndex = currentIndex; // 更新最后填充索引
                            }

                            // 修复：聚焦到最后一个填入字符的格子
                            gridCells[lastFilledIndex].focus();
                            // 定位光标到最后一格末尾
                            const range = document.createRange();
                            const sel = window.getSelection();
                            range.selectNodeContents(gridCells[lastFilledIndex]);
                            range.collapse(false);
                            sel.removeAllRanges();
                            sel.addRange(range);
                        } else if (this.textContent) {
                            // 单个字符输入：正常跳下一格
                            const currentIndex = gridCells.indexOf(this);
                            if (currentIndex < gridCells.length - 1) {
                                gridCells[currentIndex + 1].focus();
                            }
                        }

                        updateCount();
                    });

                    gridContainer.appendChild(cell);
                    gridCells.push(cell);
                }
            }

            updateCount();
        }

        function clearGrid() {
            gridCells.forEach(cell => {
                if (cell.contentEditable) cell.textContent = '';
            });
            updateCount();
            alert('已清空内容！');
        }

        function copyAllContent() {
            let content = '';
            for (let row = 0; row < currentRow; row++) {
                let rowContent = '';
                const rowCells = gridCells.slice(row * COL_NUM, (row + 1) * COL_NUM);
                rowCells.forEach(cell => {
                    rowContent += cell.textContent.trim() || '□';
                });
                content += rowContent + '\n';
            }

            navigator.clipboard.writeText(content)
               .then(() => alert('复制成功！可粘贴到备忘录/Word'))
               .catch(() => alert('复制失败，请手动选中内容复制'));
        }

        function exportAsImage() {
            const gridContainer = document.getElementById('gridContainer');
            const controlPanel = document.querySelector('.control-panel');
            controlPanel.style.display = 'none';

            html2canvas(gridContainer, { scale: 2 })
               .then(canvas => {
                    const link = document.createElement('a');
                    link.download = `申论练习_${new Date().toLocaleDateString()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    controlPanel.style.display = 'flex';
                    alert('图片已生成，可在浏览器下载记录中找到！');
                })
               .catch(() => {
                    controlPanel.style.display = 'flex';
                    alert('导出失败，请重试！');
                });
        }

        function updateCount() {
            const used = gridCells.filter(cell => cell.textContent.trim()!== '').length;
            const total = parseInt(document.getElementById('totalGrid').textContent);
            const countInfo = document.getElementById('countInfo');
            countInfo.innerHTML = `已用格子：${used} / ${total}`;
            countInfo.className = used > total? 'count-info red' : 'count-info';
        }

        window.addEventListener('beforeunload', () => {
            const content = gridCells.map(cell => cell.textContent);
            localStorage.setItem('shenlunData', JSON.stringify({
                rows: currentRow,
                content: content
            }));
        });

        window.onload = () => {
            const savedData = JSON.parse(localStorage.getItem('shenlunData'));
            if (savedData) {
                currentRow = savedData.rows;
                document.getElementById('rowInput').value = currentRow;
            }
            generateGrid();
            if (savedData?.content) {
                savedData.content.forEach((text, index) => {
                    if (gridCells[index]) gridCells[index].textContent = text;
                });
                updateCount();
            }
        };
    </script>
</body>
</html>